<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migraci√≥n de Evaluaciones - CLC Reports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            margin-bottom: 0.25rem;
        }
        .log-info { color: #0d6efd; }
        .log-success { color: #198754; }
        .log-warning { color: #fd7e14; }
        .log-error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">üîÑ Migraci√≥n de Evaluaciones Hist√≥ricas</h1>
                
                <div class="alert alert-warning" role="alert">
                    <h5 class="alert-heading">‚ö†Ô∏è Importante</h5>
                    <p>Esta herramienta actualizar√° todas las evaluaciones hist√≥ricas en Firebase para aplicar las nuevas exclusiones de par√°metros por sucursal.</p>
                    <hr>
                    <p class="mb-0"><strong>Aseg√∫rate de tener un respaldo de la base de datos antes de continuar.</strong></p>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">üéØ ¬øQu√© hace esta migraci√≥n?</h5>
                    </div>
                    <div class="card-body">
                        <ul>
                            <li>Lee todas las evaluaciones existentes en Firebase</li>
                            <li>Aplica las nuevas exclusiones de par√°metros por sucursal</li>
                            <li>Recalcula los puntajes eliminando par√°metros que ya no aplican</li>
                            <li>Actualiza las evaluaciones en Firebase</li>
                            <li>Mantiene un log detallado del proceso</li>
                        </ul>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <button id="btn-iniciar" class="btn btn-primary btn-lg w-100" onclick="iniciarMigracion()">
                            üöÄ Iniciar Migraci√≥n
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button id="btn-limpiar" class="btn btn-secondary w-100" onclick="limpiarLog()">
                            üßπ Limpiar Log
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìã Log de Migraci√≥n</h5>
                        <span id="status" class="badge bg-secondary">Listo</span>
                    </div>
                    <div class="card-body">
                        <div id="log-container" class="log-container"></div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title" id="total-evaluaciones">0</h5>
                                    <p class="card-text">Total Evaluaciones</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title" id="procesadas">0</h5>
                                    <p class="card-text">Procesadas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title" id="actualizadas">0</h5>
                                    <p class="card-text">Actualizadas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title" id="sin-cambios">0</h5>
                                    <p class="card-text">Sin Cambios</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import './js/migration-script.js';
        
        let stats = {
            total: 0,
            procesadas: 0,
            actualizadas: 0,
            sinCambios: 0
        };

        // Sobrescribir console.log para capturar logs
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLogEntry(args.join(' '), 'info');
        };

        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            addLogEntry(args.join(' '), 'error');
        };

        const originalWarn = console.warn;
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLogEntry(args.join(' '), 'warning');
        };

        function addLogEntry(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-${type}';
            entry.textContent = '[${new Date().toLocaleTimeString()}] ${message}';
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(status, variant = 'secondary') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = status;
            statusEl.className = 'badge bg-${variant}';
        }

        function updateStats() {
            document.getElementById('total-evaluaciones').textContent = stats.total;
            document.getElementById('procesadas').textContent = stats.procesadas;
            document.getElementById('actualizadas').textContent = stats.actualizadas;
            document.getElementById('sin-cambios').textContent = stats.sinCambios;
        }

        window.iniciarMigracion = async function() {
            const btnIniciar = document.getElementById('btn-iniciar');
            btnIniciar.disabled = true;
            btnIniciar.innerHTML = '‚è≥ Migrando...';
            
            updateStatus('Ejecutando', 'warning');
            addLogEntry('Iniciando migraci√≥n de evaluaciones hist√≥ricas...', 'info');
            
            try {
                await window.migrarEvaluacionesHistoricas();
                updateStatus('Completado', 'success');
                addLogEntry('‚úÖ Migraci√≥n completada exitosamente', 'success');
            } catch (error) {
                updateStatus('Error', 'danger');
                addLogEntry('‚ùå Error en la migraci√≥n: ' + error.message, 'error');
            } finally {
                btnIniciar.disabled = false;
                btnIniciar.innerHTML = 'üöÄ Iniciar Migraci√≥n';
            }
        };

        window.limpiarLog = function() {
            document.getElementById('log-container').innerHTML = '';
            stats = { total: 0, procesadas: 0, actualizadas: 0, sinCambios: 0 };
            updateStats();
            updateStatus('Listo', 'secondary');
        };

        // Inicializar
        updateStats();
        addLogEntry('Sistema de migraci√≥n listo', 'success');
    </script>
</body>
</html>